<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1, h2, h3 {
      margin: 10px 0;
    }
    .panel {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .hidden {
      display: none;
    }
    .btn {
      padding: 10px 18px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary {
      background: #0066cc;
      color: #fff;
    }
    .btn-primary:hover {
      background: #004c99;
    }
    .btn-danger {
      background: #c0392b;
      color: #fff;
    }
    .btn-danger:hover {
      background: #922b21;
    }
    .btn-gray {
      background: #777;
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 4px;
    }
    th {
      background: #f0f0f0;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      margin: 0 3px;
    }
    .badge-abs { background:#2ecc71; color:#fff; }
    .badge-morning { background:#f1c40f; color:#000; }
    .badge-viol { background:#e67e22; color:#fff; }

    input[type="password"] {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="panel" id="loginPanel">
    <h1>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h1>
    <p>https://script.google.com/macros/s/AKfycbzXuOFz-SJCiGbaPmlepX47CYg1ZOJodgMPWRpSq8QLHXb7ud9WSEwBpCm72eAlWvbJ/exec</p>
    <input type="password" id="supPass" placeholder="â€¢â€¢â€¢â€¢" />
    <button class="btn btn-primary" onclick="checkSupervisorPass()">Ø¯Ø®ÙˆÙ„</button>
  </div>

  <div class="panel hidden" id="mainPanel">
    <h1>ğŸ“˜ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</h1>
    <h3>
      <span class="badge badge-abs">Ø§Ù„ØºÙŠØ§Ø¨</span>
      <span class="badge badge-morning">Ø§Ù„ØªØ£Ø®Ø±</span>
      <span class="badge badge-viol">Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª</span>
    </h3>

    <div style="margin-top:10px;">
      <button class="btn btn-primary" onclick="loadReport('Abs')">ğŸ“— ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨</button>
      <button class="btn btn-primary" onclick="loadReport('Morning')">ğŸ“™ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ£Ø®Ø±</button>
      <button class="btn btn-primary" onclick="loadReport('Viol')">ğŸ“• ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª</button>
    </div>

    <div id="currentTypeLabel" style="margin-top:10px; font-weight:bold;"></div>
    <div id="countLabel" style="margin-top:5px;"></div>

    <div id="tableContainer"></div>

    <div style="margin-top:15px;">
      <button class="btn btn-danger" onclick="sendAllWhatsApp()" id="sendAllBtn" disabled>
        ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±
      </button>
    </div>
  </div>

  <script>
    // ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwVYDoKDX0QmRmdkfk9gyz3KFrmnqxE7NMOEEEqr7FRsU2SJUujZeZYxUiVBD8xxNl_/exec";

    // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† (ÙˆØ§ØªØ³Ø§Ø¨) - Ø¹Ø¯Ù„Ù‡Ø§ ÙƒÙ…Ø§ ØªØ´Ø§Ø¡
    const supervisorNumbers = [
      "9689XXXXXXX",
      "9689YYYYYYY"
    ];

    const ULTRA_INSTANCE = "instance150506";
    const ULTRA_TOKEN = "lwcl28v4w3jgfxzw";

    let currentRows = [];
    let currentType = null;

    // âœ… ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (1982)
    function checkSupervisorPass() {
      const pass = document.getElementById('supPass').value.trim();
      if (pass === "1982") {
        document.getElementById('loginPanel').classList.add('hidden');
        document.getElementById('mainPanel').classList.remove('hidden');
      } else {
        alert("âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­");
      }
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Web App Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    function loadReport(type) {
      currentType = type;
      document.getElementById('sendAllBtn').disabled = true;
      document.getElementById('tableContainer').innerHTML = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
      document.getElementById('countLabel').textContent = "";

      let label =
        type === "Abs" ? "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨" :
        type === "Morning" ? "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ£Ø®Ø±" :
        "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª";

      document.getElementById('currentTypeLabel').textContent = label;

      fetch(WEBAPP_URL + "?type=" + encodeURIComponent(type))
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data)) data = [];
          currentRows = data;

          if (data.length === 0) {
            document.getElementById('tableContainer').innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹.";
            document.getElementById('countLabel').textContent = "";
            document.getElementById('sendAllBtn').disabled = true;
            return;
          }

          document.getElementById('countLabel').textContent =
            "Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: " + data.length;

          renderTable(data);
          document.getElementById('sendAllBtn').disabled = false;
        })
        .catch(err => {
          console.error(err);
          alert("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…");
          document.getElementById('tableContainer').innerHTML = "";
          document.getElementById('sendAllBtn').disabled = true;
        });
    }

    // âœ… Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function renderTable(rows) {
      let html = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody>
      `;

      rows.forEach((r, idx) => {
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${r.time || ""}</td>
            <td>${r.name || ""}</td>
            <td>${r.phone || ""}</td>
            <td>${r.message || ""}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      document.getElementById('tableContainer').innerHTML = html;
    }

    // âœ… ØªØ·Ø¨ÙŠØ¹ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø¥Ø¶Ø§ÙØ© 968 Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)
    function normalizePhone(phone) {
      if (!phone) return null;
      phone = String(phone).trim();
      if (!phone) return null;

      if (phone.startsWith("9")) {
        phone = "968" + phone;
      } else if (!phone.startsWith("968")) {
        // Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø§Ù„ØµÙŠØºØ©
        return null;
      }
      return phone;
    }

    // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¬ÙŠÙ…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±
    async function sendAllWhatsApp() {
      if (!currentRows || currentRows.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§");
        return;
      }

      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±ØŸ")) {
        return;
      }

      document.getElementById('sendAllBtn').disabled = true;
      document.getElementById('sendAllBtn').textContent = "ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

      let sentCount = 0;
      let skipCount = 0;

      for (let row of currentRows) {
        const phone = normalizePhone(row.phone);
        const msg = row.message || "";

        if (!phone || !msg) {
          skipCount++;
          continue;
        }

        const finalMessage =
          msg + "\n\nÙ…Ø¹ ØªØ­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©";

        try {
          await sendWhatsAppToParent(phone, finalMessage);
          sentCount++;
        } catch (err) {
          console.error("send error", err);
          skipCount++;
        }
      }

      document.getElementById('sendAllBtn').disabled = false;
      document.getElementById('sendAllBtn').textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±";

      alert(`âœ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${sentCount} Ø±Ø³Ø§Ù„Ø©ØŒ ÙˆØªØ®Ø·ÙŠ ${skipCount} Ø¨Ø³Ø¨Ø¨ Ù†Ù‚Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.`);
    }

    // âœ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ UltraMsg Ù„ÙˆÙ„ÙŠ Ø£Ù…Ø± ÙˆØ§Ø­Ø¯
    async function sendWhatsAppToParent(phone, message) {
      const url = `https://api.ultramsg.com/${ULTRA_INSTANCE}/messages/chat`;

      const body = new URLSearchParams({
        token: ULTRA_TOKEN,
        to: phone,
        body: message
      });

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString()
      });

      const txt = await res.text();
      console.log("UltraMsg response:", txt);
      return txt;
    }

  </script>
</body>
</html>
