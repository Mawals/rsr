<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ù†ØµØ© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø© Ø¨Ù…Ø¯Ø±Ø³Ø© Ù…Ø¹ÙˆÙ„Ø© Ø¨Ù† Ø´Ù…Ø³</title>
  <link rel="icon" href="logo_no_bg.png" type="image/png">
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #e6f4ff; color: #111; margin: 0; direction: rtl; }
    .menu-container { text-align: center; padding: 60px 20px; }
    .menu-btn { padding: 20px 40px; margin: 15px; border: none; border-radius: 10px; font-size: 20px; cursor: pointer; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .absence-btn { background-color: #16a34a; }
    .violation-btn { background-color: #dc2626; }
    .morning-btn { background-color: #6a1b9a; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: right; }
    th { background: #d9f0ff; color: #003f66; }
    button { cursor: pointer; border-radius: 8px; padding: 10px 15px; }
    .present { background: #16a34a; color: #fff; }
    .absent { background: #dc2626; color: #fff; }
  </style>
</head>
<body>
  <div id="mainMenu" class="menu-container">
    <img src="logo_no_bg.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" style="width: 120px; height: auto; margin-bottom: 10px;">
    <h2>Ù…Ù†ØµØ© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø© Ø¨Ù…Ø¯Ø±Ø³Ø© Ù…Ø¹ÙˆÙ„Ø© Ø¨Ù† Ø´Ù…Ø³</h2>
    <button class="menu-btn absence-btn" onclick="showSection('absenceSection')">ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</button>
    <button class="menu-btn violation-btn" onclick="showSection('violationSection')">âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</button>
    <button class="menu-btn morning-btn" onclick="showSection('morningLateSection')">â° Ø§Ù„ØªØ£Ø®Ø± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ</button>
  </div>

  <div id="violationSection" class="hidden">
    <button onclick="showSection('mainMenu')">Ø±Ø¬ÙˆØ¹</button>
    <h3>ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø¨Ø©</h3>
    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <input id="teacherNameViol" type="text"></label>
    <label>Ø§Ù„ØµÙ: <select id="gradeSelectViol"><option value="">Ø§Ø®ØªØ±</option><option value="10">Ø§Ù„Ø¹Ø§Ø´Ø±</option></select></label>
    <label>Ø§Ù„Ø´Ø¹Ø¨Ø©: <select id="sectionSelectViol"><option value="">Ø§Ø®ØªØ±</option><option value="1">1</option></select></label>
    <button onclick="loadCSVData('Viol')">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
    <button onclick="exportData('Viol')">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
    <table>
      <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th></tr></thead>
      <tbody id="studentsBodyViol"><tr><td colspan="4">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr></tbody>
    </table>
  </div>

<script>
const SHEET_URLS = ['https://docs.google.com/spreadsheets/d/e/2PACX-1vSJ3CGPHmBFZ8myoys49bw1MLrC_tfdcKuZ-ZBSMczVqLZbxzSe-LZbyqCDv2YZLQ/pub?gid=626465739&single=true&output=csv'];
const EXPORT_WEBAPP_URLS = {
  Abs: "https://script.google.com/macros/s/AKfycbzAifn3f7ZVRqnZZzU6RAlyexqwYpSjCu-yqpPpgYV3ZluUG6fXOfRoRo9XvvaDpd9m/exec",
  Viol: "https://script.google.com/macros/s/AKfycbzAifn3f7ZVRqnZZzU6RAlyexqwYpSjCu-yqpPpgYV3ZluUG6fXOfRoRo9XvvaDpd9m/exec",
  Morning: "https://script.google.com/macros/s/AKfycbzAifn3f7ZVRqnZZzU6RAlyexqwYpSjCu-yqpPpgYV3ZluUG6fXOfRoRo9XvvaDpd9m/exec"
};

const state = { Viol: { students: [], violations: {} } };

function showSection(id) {
  document.querySelectorAll('#mainMenu, #violationSection').forEach(div => div.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

async function loadCSVData(type) {
  try {
    let text = await fetch(SHEET_URLS[0]).then(res => res.text());
    const lines = text.split('\n').slice(1);
    const students = lines.map((line, i) => {
      const cols = line.split(',');
      return { id: i + 1, phone: cols[0]?.trim(), name: cols[1]?.trim() };
    });
    state.Viol.students = students;
    renderViolations();
  } catch (err) { alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); }
}

function renderViolations() {
  const tbody = document.getElementById('studentsBodyViol');
  tbody.innerHTML = '';
  const violations = ['', 'Ø§Ù„Ù†ÙˆÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØ©', 'Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø²ÙŠ', 'Ø§Ù„Ø¥Ø³Ø§Ø¡Ø© Ù„Ø²Ù…ÙŠÙ„'];
  state.Viol.students.forEach((s, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i + 1}</td><td>${s.name}</td><td>${s.phone}</td>`;
    const td = document.createElement('td');
    const select = document.createElement('select');
    violations.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v; opt.textContent = v;
      select.appendChild(opt);
    });
    select.onchange = () => state.Viol.violations[s.id] = select.value;
    td.appendChild(select);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}

function exportData(type) {
  const teacher = document.getElementById('teacherNameViol').value.trim() || 'Ø§Ù„Ù…Ø¹Ù„Ù…';
  const today = new Date().toLocaleDateString('ar-EG');
  const viols = state.Viol.students.filter(s => state.Viol.violations[s.id]);
  if (!viols.length) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø®Ø§Ù„ÙØ§Øª');

  const rows = viols.map((s, i) => ({
    serial: i + 1,
    phone: s.phone,
    name: s.name,
    message: `ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ ${s.name}ØŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ© (${state.Viol.violations[s.id]}) Ø¨ØªØ§Ø±ÙŠØ® ${today}. â€” Ø§Ù„Ù…Ø¹Ù„Ù…: ${teacher}`
  }));

  fetch(EXPORT_WEBAPP_URLS[type], {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(rows)
  }).then(() => alert('âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­')).catch(() => alert('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'));
}
</script>
</body>
</html>